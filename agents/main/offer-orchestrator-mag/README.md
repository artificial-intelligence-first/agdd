# OfferOrchestratorMAG

**Version:** 0.1.0
**Role:** Main Agent (MAG)
**Slug:** `offer-orchestrator-mag`

## Purpose

OfferOrchestratorMAG is the main orchestration agent responsible for coordinating the complete offer generation process. It manages the end-to-end workflow from candidate profile intake to final offer packet delivery.

## Responsibilities

As a Main Agent (MAG), OfferOrchestratorMAG handles:

1. **Task Decomposition** - Analyzes candidate profile and determines required sub-tasks
2. **Planning & Strategy** - Decides which SAGs to invoke and in what order
3. **Delegation** - Invokes specialized sub-agents (SAGs) with appropriate context
4. **State Management** - Maintains execution state across multiple SAG invocations
5. **Context Propagation** - Passes run_id, task metadata to sub-agents for traceability
6. **Result Aggregation** - Combines outputs from multiple SAGs into cohesive result
7. **Error Handling** - Manages failures, retries, and fallback strategies
8. **Observability** - Emits comprehensive logs and metrics for governance

## Architecture

```
┌─────────────────────────────────────────────┐
│      OfferOrchestratorMAG (Main Agent)      │
└──────────────────┬──────────────────────────┘
                   │
         ┌─────────┴─────────┐
         │                   │
    ┌────▼────┐         ┌────▼────┐
    │  Task   │         │ Result  │
    │  Decomp │         │  Aggr   │
    │  Skill  │         │  Skill  │
    └────┬────┘         └────▲────┘
         │                   │
         │    ┌──────────────┘
         │    │
    ┌────▼────▼──────────────────────┐
    │ CompensationAdvisorSAG (Sub)   │
    └────────────┬───────────────────┘
                 │
           ┌─────▼──────┐
           │ Salary Band│
           │   Lookup   │
           │   Skill    │
           └────────────┘
```

## Dependencies

### Sub-Agents
- `compensation-advisor-sag@>=0.1.0` - Generates compensation recommendations

### Skills
- `skill.task-decomposition@>=0.1.0` - Decomposes high-level tasks (optional, has fallback)
- `skill.result-aggregation@>=0.1.0` - Aggregates sub-agent results (optional, has fallback)

## Contracts

### Input Schema
**File:** `contracts/candidate_profile.schema.json`

Example:
```json
{
  "role": "Senior Software Engineer",
  "level": "Senior",
  "location": "San Francisco, CA",
  "experience_years": 8,
  "notes": "Referral from Alice"
}
```

### Output Schema
**File:** `contracts/offer_packet.schema.json`

Example:
```json
{
  "offer": {
    "role": "Senior Software Engineer",
    "base_salary": {
      "currency": "USD",
      "amount": 185000
    },
    "band": {
      "currency": "USD",
      "min": 150000,
      "max": 220000,
      "source": "internal-table+location-adjustment"
    },
    "sign_on_bonus": {
      "currency": "USD",
      "amount": 20000
    },
    "notes": "Generated by CompensationAdvisorSAG..."
  },
  "metadata": {
    "generated_by": "OfferOrchestratorMAG",
    "run_id": "mag-a1b2c3d4",
    "timestamp": "2025-10-21T12:34:56.789Z",
    "version": "0.1.0",
    "task_count": 1,
    "successful_tasks": 1
  }
}
```

## Execution Flow

### Phase 1: Task Decomposition
1. Receive candidate profile input
2. Invoke `task-decomposition` skill (if available)
3. Generate task list with SAG assignments
4. Fallback: Single task to `compensation-advisor-sag`

### Phase 2: SAG Delegation
1. For each task:
   - Create `Delegation` object with task_id, sag_id, input, context
   - Invoke SAG via agent runner
   - Collect `Result` with status, output, metrics
2. Log each delegation start/complete event
3. Handle partial failures gracefully

### Phase 3: Result Aggregation
1. Collect successful SAG outputs
2. Invoke `result-aggregation` skill (if available)
3. Merge complementary data, resolve conflicts
4. Fallback: Use first successful result

### Phase 4: Metadata Enrichment
1. Wrap aggregated offer in standard packet structure
2. Add execution metadata (run_id, timestamp, version)
3. Include task statistics (total tasks, successful tasks)

### Phase 5: Finalization
1. Emit metrics (latency, task count, success count)
2. Log completion event with summary
3. Return final offer packet

## Configuration

### Risk Class
- **Level:** `low` - Standard offer generation with well-defined constraints

### Budgets
- **Tokens:** 200,000 (for LLM-based skills if used)
- **Time:** 60 seconds

### Retry Policy
- **Max Attempts:** 1 (SAGs have their own retry logic)

### Observability
- **Logs:** Enabled (all phases logged)
- **Metrics:** Enabled (latency, task counts)
- **Traces:** Basic (run_id propagation)

## Usage

### Via CLI
```bash
# Prepare candidate profile
cat > candidate.json <<EOF
{
  "role": "Staff Engineer",
  "level": "Staff",
  "location": "Remote - US",
  "experience_years": 12
}
EOF

# Run orchestrator
uv run python -m agdd.cli agent run offer-orchestrator-mag --json candidate.json
```

### Programmatic
```python
from agdd.runners.agent_runner import invoke_mag

payload = {
    "role": "Product Manager",
    "level": "Senior",
    "location": "New York, NY",
    "experience_years": 6
}

offer_packet = invoke_mag("offer-orchestrator-mag", payload)
print(f"Base salary: ${offer_packet['offer']['base_salary']['amount']:,}")
```

## Error Handling

### SAG Failures
- Logs delegation failure with task_id and error
- Continues with remaining tasks
- Aggregates partial results
- Final output may have incomplete offer components

### Skill Failures
- Task decomposition failure → fallback to single-task strategy
- Aggregation failure → use first successful SAG result
- All skill errors logged for observability

### Top-Level Exceptions
- Catches all unhandled exceptions
- Logs error with type, message, duration
- Re-raises for caller to handle
- Ensures observability artifacts are written

## Observability

Execution artifacts in `.runs/agents/<RUN_ID>/`:

### logs.jsonl
```jsonl
{"run_id":"mag-a1b2c3d4","event":"start","timestamp":1729510496.789,"data":{"agent":"OfferOrchestratorMAG"}}
{"run_id":"mag-a1b2c3d4","event":"decomposition","timestamp":1729510496.850,"data":{"task_count":1}}
{"run_id":"mag-a1b2c3d4","event":"delegation_start","timestamp":1729510496.851,"data":{"task_id":"task-xyz789","sag_id":"compensation-advisor-sag"}}
{"run_id":"mag-a1b2c3d4","event":"delegation_complete","timestamp":1729510497.123,"data":{"task_id":"task-xyz789","status":"success"}}
{"run_id":"mag-a1b2c3d4","event":"aggregation","timestamp":1729510497.125,"data":{"result_count":1}}
{"run_id":"mag-a1b2c3d4","event":"end","timestamp":1729510497.150,"data":{"status":"success","duration_ms":361,"tasks":1,"successful":1}}
```

### metrics.json
```json
{
  "latency_ms": [{"run_id":"mag-a1b2c3d4","value":361,"timestamp":1729510497.150}],
  "task_count": [{"run_id":"mag-a1b2c3d4","value":1,"timestamp":1729510497.150}],
  "success_count": [{"run_id":"mag-a1b2c3d4","value":1,"timestamp":1729510497.150}]
}
```

## Testing

```bash
# Unit tests
uv run -m pytest tests/agents/test_offer_orchestrator_mag.py -v

# Integration tests
uv run -m pytest tests/integration/test_e2e_offer_flow.py -v
```

## Future Enhancements

- **Parallel SAG Invocation** - Execute independent tasks concurrently
- **Dynamic Routing** - Choose SAG variants based on A/B testing or scoring
- **Plan Validation** - Pre-flight check of task plan against budgets/policies
- **Compensation Approval Workflow** - Integrate with approval chain for high-value offers
- **Multi-Stage Orchestration** - Support complex workflows (screening → offer → negotiation)
- **Circuit Breaker** - Fail fast when SAG error rate exceeds threshold
