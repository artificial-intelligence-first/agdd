# CompensationAdvisorSAG

**Version:** 0.1.0
**Role:** Sub-agent
**Slug:** `compensation-advisor-sag`

## Purpose

CompensationAdvisorSAG is a specialized sub-agent responsible for generating compensation recommendations for job candidates. It combines salary band data with candidate attributes to produce structured offer components including base salary, sign-on bonus, and equity (when applicable).

## Responsibilities

- Analyze candidate profile (role, level, location, experience)
- Invoke `salary-band-lookup` skill to retrieve market-aligned salary bands
- Calculate appropriate base salary within band constraints
- Recommend sign-on bonus based on role seniority
- Generate structured offer output conforming to `comp_advisor_output` schema

## Dependencies

### Skills
- `skill.salary-band-lookup@>=0.1.0` - Retrieves salary bands from internal tables/market data

## Contracts

### Input Schema
**File:** `contracts/comp_advisor_input.schema.json`

```json
{
  "candidate_profile": {
    "role": "Senior Software Engineer",
    "level": "Senior",
    "location": "San Francisco, CA",
    "experience_years": 8
  }
}
```

### Output Schema
**File:** `contracts/comp_advisor_output.schema.json`

```json
{
  "offer": {
    "role": "Senior Software Engineer",
    "base_salary": {
      "currency": "USD",
      "amount": 185000
    },
    "band": {
      "currency": "USD",
      "min": 150000,
      "max": 220000,
      "source": "internal-table+location-adjustment"
    },
    "sign_on_bonus": {
      "currency": "USD",
      "amount": 20000
    },
    "notes": "Generated by CompensationAdvisorSAG based on internal-table+location-adjustment data"
  }
}
```

## Configuration

### Retry Policy
- **Max Attempts:** 2
- **Backoff:** 500ms exponential

### Observability
- **Logs:** Enabled
- **Metrics:** Enabled

## Usage

### Direct Invocation (for testing)
```bash
# Via agent runner
python -c "
from magsag.runners.agent_runner import invoke_sag, Delegation
result = invoke_sag(Delegation(
    task_id='test-001',
    sag_id='compensation-advisor-sag',
    input={'candidate_profile': {'role': 'Software Engineer', 'level': 'Mid'}},
    context={}
))
print(result.output)
"
```

### Invocation from MAG
```python
from magsag.runners.agent_runner import invoke_sag, Delegation

delegation = Delegation(
    task_id="comp-task-001",
    sag_id="compensation-advisor-sag",
    input={"candidate_profile": candidate_data},
    context={"parent_run_id": "mag-abc123"}
)

result = runner.invoke_sag(delegation)
offer = result.output["offer"]
```

## Implementation Details

### Salary Calculation Strategy
1. Retrieve salary band via skill (min/max range)
2. Calculate experience factor: `min(experience_years / 10, 0.8)`
3. Position within band: `base = min + (range * (0.2 + experience_factor))`
4. This ensures:
   - Minimum 20% into band for any candidate
   - Maximum 100% for 10+ years experience
   - Linear progression based on experience

### Sign-On Bonus Logic
- Junior/Mid: $10,000
- Senior: $20,000
- Staff: $30,000
- Principal: $50,000

### Error Handling
- If `salary-band-lookup` skill fails, fallback to default band ($100k-$180k USD)
- All errors logged via observability interface
- Retry policy applies to transient failures (network, DB timeout)

## Testing

Run SAG-specific tests:
```bash
uv run -m pytest tests/agents/test_compensation_advisor_sag.py -v
```

## Observability

Execution artifacts written to `.runs/agents/<RUN_ID>/`:
- `logs.jsonl` - Event log (start, skill_invoked, skill_error, end)
- `metrics.json` - Performance metrics (duration_ms)
- `summary.json` - Run summary

## Future Enhancements

- Equity/RSU recommendations based on role and company stage
- Benefits package suggestions (401k match, healthcare tiers)
- Geographic cost-of-living adjustments (automated via MCP)
- Integration with comp approval workflows
- Multi-currency support with FX conversion
